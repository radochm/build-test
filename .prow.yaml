presubmits:
  - name: vi-test
    decorate: true
    always_run: true
    spec:
      containers:
      - image: golang:1.20.2
        command:
        - "/bin/sh"
        args:
        - "-c"
        - |
          make unit
          make lint
          make gosec
          make -version
          pwd
          ls
          whoami
          export
  - name: j-test
    decorate: true
    always_run: true
    spec:
      containers:
      - image: golang:1.20.2
        command:
        - "/bin/sh"
        args:
        - "-c"
        - |
          env
  - name: nmath-test
    decorate: true
    run_if_changed: "(\\.go|^Makefile)$"
    spec:
      containers:
      - image: golang:1.20.2
        command:
        - make
        args:
        - unit
  - name: nmath-test-fmt
    decorate: true
    run_if_changed: "(\\.go)$"
    spec:
      containers:
      - image: golang:1.20.2
        command:
        - make
        args:
        - lint
  - name: nmath-test-vet
    decorate: true
    run_if_changed: "(\\.go)$"
    spec:
      containers:
      - image: golang:1.20.2
        command:
        - make
        args:
        - gosec

postsubmits:
  - name: verify-image-build
    cluster: default
    branches:
    - main
    run_if_changed: "(\\.go|^Makefile|^Dockerfile)$"
    skip_branches:
    annotations:
      description: Verify image build on pull requests to main branch
    decorate: true
    decoration_config:
      censor_secrets: true
    max_concurrency: 1
    spec:
      containers:
      - name: kaniko
        image: gcr.io/kaniko-project/executor:v1.9.2
        command:
        - /kaniko/executor
        args:
        - --context=/home/prow/go/src/github.com/radochm/build-test
        - --dockerfile=Dockerfile
        - --no-push
        resources:
          requests:
            cpu: 2
            memory: 2Gi

  - name: push-image
    cluster: default
    always_run: false
    run_if_changed: "^VERSION$"
    skip_branches:
    annotations:
      description: Push image to DockerHub
    decorate: true
    decoration_config:
      censor_secrets: true
    max_concurrency: 1
    spec:
      containers:
      - name: kaniko
        image: gcr.io/kaniko-project/executor:v1.9.2
        command:
        - /kaniko/executor
        args:
        - --context=/home/prow/go/src/github.com/radochm/build-test
        - --dockerfile=Dockerfile
        - --destination=radoslawc/nmath:2
        volumeMounts:
          - name: kaniko-secret
            mountPath: /kaniko/.docker/
        resources:
          requests:
            cpu: 2
            memory: 2Gi
      volumes:
        - name: kaniko-secret
          secret:
            secretName: regcred
            items:
              - key: .dockerconfigjson
                path: config.json
